<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />
    <link rel="stylesheet" href="/CSS/nav.css" />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        background: linear-gradient(
            rgba(25, 25, 25, 0.85),
            rgba(25, 25, 25, 0.85)
          ),
          url("/IMG/login_signup_background.png");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        font-family: sans-serif;
      }
    </style>
  </head>
  <body>
    <header>
      <nav>
        <div class="logo">
          <h1>LearnQuest</h1>
        </div>
        <ul>
          <li><a href="../index.html">Home</a></li>
          <li id="quiz-tab" class="hidden">
            <a href="quiz.html">Quizzes</a>
          </li>
          <li id="achievement-tab" class="hidden">
            <a href="achivement.html">Achivement</a>
          </li>
          <li id="leaderboard-tab" class="hidden">
            <a href="leaderboard.html">Leaderboard</a>
          </li>
          <li id="aisuggestions-tab" class="hidden">
            <a href="aisuggestions.html">AI review</a>
          </li>
          <li>
            <button onclick="loginpage()" id="login-btn" class="login-btn">
              Login
            </button>
          </li>
          <li id="pro" onclick="toggleProfile()" class="profile">
            <span id="profile" class="material-symbols-outlined"
              >account_circle</span
            >
          </li>
        </ul>
        <div class="icon" id="burger">
          <span id="bar" class="material-symbols-outlined">menu</span>
        </div>
        <div class="sub-menu-wrap" id="submenu">
          <div class="sub-menu">
            <div><p id="log-email"></p></div>
            <hr />
            <div id="profile-logout" class="logout-area">
              <span class="material-symbols-outlined">logout</span>Logout
            </div>
          </div>
        </div>
      </nav>
    </header>
    <div id="ai-suggestions" style="padding: 2rem"></div>
    <script type="module">
      import { auth, db } from "../JavaScript/firbase-config.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
      import {
        collection,
        getDoc,
        getDocs,
        doc,
      } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

      const suggestionsContainer = document.getElementById("ai-suggestions");

      function renderSuggestionCard(quiz, message, progress) {
        const card = document.createElement("div");
        card.style.background = "#222a";
        card.style.borderRadius = "1rem";
        card.style.margin = "1rem 0";
        card.style.padding = "1.5rem";
        card.style.boxShadow = "0 2px 8px #0003";
        card.style.display = "flex";
        card.style.flexDirection = "column";
        card.style.gap = "0.5rem";
        card.innerHTML = `
          <h2 style="margin:0 0 0.5rem 0;">${quiz.title}</h2>
          <div style="font-size:1rem;color:#aaa;">${
            quiz.description || ""
          }</div>
          <div style="margin:0.5rem 0;">
            <progress value="${progress}" max="100" style="width:80%;height:1.2rem;"></progress>
            <span style="margin-left:0.5rem;">${progress}%</span>
          </div>
          <div style="color:#6cf;font-weight:bold;">${message}</div>
          <button style="margin-top:0.5rem;padding:0.5rem 1.5rem;border:none;border-radius:0.5rem;background:#6cf;color:#fff;font-size:1rem;cursor:pointer;" onclick="window.location.href='quiz.html?quizId=${
            quiz.id
          }'">Start Quiz</button>
        `;
        suggestionsContainer.appendChild(card);
      }

      function analyzePerformanceAndSuggest(categories, userHistory) {
        const suggestions = [];
        categories.forEach((cat) => {
          const history = userHistory[cat.id];
          if (!history) {
            suggestions.push({
              category: cat,
              message: "New topic! Try this category to expand your knowledge.",
              progress: 0,
            });
          } else if (history.score < 70) {
            suggestions.push({
              category: cat,
              message: `You scored ${history.score}% in ${cat.name}. Give it another shot to improve!`,
              progress: history.score,
            });
          } else if (history.score < 90) {
            suggestions.push({
              category: cat,
              message: `Good job in ${cat.name}! Try for a perfect score.`,
              progress: history.score,
            });
          }
        });
        suggestions.sort((a, b) => (a.progress || 0) - (b.progress || 0));
        return suggestions.slice(0, 5);
      }

      async function fetchUserQuizHistory(uid) {
        // Assumes user quiz history is stored as a subcollection or field in 'users' doc
        const userDoc = await getDoc(doc(db, "users", uid));
        if (!userDoc.exists()) return {};
        // Example: { quizHistory: { quizId: { score: 80, lastAttempt: ... }, ... } }
        return userDoc.data().quizHistory || {};
      }

      async function fetchAllQuizzes() {
        const quizSnap = await getDocs(collection(db, "quizzes"));
        const quizzes = [];
        quizSnap.forEach((docSnap) => {
          quizzes.push({ id: docSnap.id, ...docSnap.data() });
        });
        return quizzes;
      }

      async function fetchAllCategories() {
        const response = await fetch("https://opentdb.com/api_category.php");
        const data = await response.json();
        return data.trivia_categories; // [{id, name}]
      }

      // Render suggestion card for category
      function renderSuggestionCardCategory(category, message, progress) {
        const card = document.createElement("div");
        card.style.background = "#222a";
        card.style.borderRadius = "1rem";
        card.style.margin = "1rem 0";
        card.style.padding = "1.5rem";
        card.style.boxShadow = "0 2px 8px #0003";
        card.style.display = "flex";
        card.style.flexDirection = "column";
        card.style.gap = "0.5rem";
        card.innerHTML = `
          <h2 style="margin:0 0 0.5rem 0;">${category.name}</h2>
          <div style="margin:0.5rem 0;">
            <progress value="${progress}" max="100" style="width:80%;height:1.2rem;"></progress>
            <span style="margin-left:0.5rem;">${progress}%</span>
          </div>
          <div style="color:#6cf;font-weight:bold;">${message}</div>
          <button style="margin-top:0.5rem;padding:0.5rem 1.5rem;border:none;border-radius:0.5rem;background:#6cf;color:#fff;font-size:1rem;cursor:pointer;" onclick="window.location.href='quiz.html?category=${category.id}'">Start Quiz</button>
        `;
        suggestionsContainer.appendChild(card);
      }

      function showLoading() {
        suggestionsContainer.innerHTML =
          '<div style="color:#aaa;font-size:1.2rem;">Loading personalized suggestions...</div>';
      }
      function showNoSuggestions() {
        suggestionsContainer.innerHTML =
          '<div style="color:#aaa;font-size:1.2rem;">No suggestions available. Try more quizzes!</div>';
      }

      showLoading();
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          suggestionsContainer.innerHTML =
            '<div style="color:#faa;font-size:1.2rem;">Please log in to get personalized AI quiz suggestions.</div>';
          return;
        }
        try {
          const [userHistory, categories] = await Promise.all([
            fetchUserQuizHistory(user.uid),
            fetchAllCategories(),
          ]);
          console.log("Fetched categories:", categories);
          console.log("Fetched userHistory:", userHistory);
          const suggestions = analyzePerformanceAndSuggest(
            categories,
            userHistory
          );
          suggestionsContainer.innerHTML = "";
          if (suggestions.length === 0) {
            showNoSuggestions();
          } else {
            suggestions.forEach((s) =>
              renderSuggestionCardCategory(s.category, s.message, s.progress)
            );
          }
        } catch (e) {
          suggestionsContainer.innerHTML =
            '<div style="color:#faa;font-size:1.2rem;">Error loading suggestions.</div>';
          console.error(e);
        }
      });
    </script>
  </body>
</html>
<script src="/JavaScript/dash2.js" type="module"></script>
<script src="/JavaScript/dashboard.js"></script>
